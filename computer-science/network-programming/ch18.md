# Ch18 ë©€í‹°ìŠ¤ë ˆë“œ ì†Œì¼“í†µì‹ 

## ğŸ“– ì“°ë ˆë“œ Thread

### âœï¸ Multi Process VS Thread

ë©€í‹° í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ í”„ë¡œì„¸ìŠ¤ì˜ ìƒì„±ì—ëŠ” ë§ì€ ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ë©ë‹ˆë‹¤\
ë˜í•œ í”„ë¡œì„¸ìŠ¤ê°„ Context Switching ìœ¼ë¡œ ì¸í•´ ì‹œìŠ¤í…œ ì„±ëŠ¥ì´ ì €í•˜ ë  ë¿ë§Œ ì•„ë‹ˆë¼, ë…ë¦½ì ì¸ ë©”ëª¨ë¦¬ ê³µê°„ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— í”„ë¡œì„¸ìŠ¤ê°„ ë°ì´í„° ê³µìœ ê°€ í˜ë“¤ë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.

ë°˜ë©´ ìŠ¤ë ˆë“œëŠ” í”„ë¡œì„¸ìŠ¤ë³´ë‹¤ ê°€ë³ê³ , ë©”ëª¨ë¦¬ ê³µìœ ê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤

### âœï¸ Thread

ìŠ¤ë ˆë“œëŠ” í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ ë‚´ë¶€ì—ì„œ ë™ì‘í•˜ê³ ,\
Data ì™€ Heap ì˜ì—­ì„ ê³µìœ í•˜ê¸° ë•Œë¬¸ì—, ì“°ë ˆë“œ ì‚¬ì´ ë°ì´í„° êµí™˜ì´ ì‰½ê²Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

### âœï¸ pthread\_create() ì“°ë ˆë“œì˜ ìƒì„±

```c
#include <pthread.h>
int pthread_create(pthread_t *restrict thread, const pthread_attr_t *restrict attr, void *(*start_routine)(void*), void *restrict arg);
// thread : ìƒì„±í•  ì“°ë ˆë“œ ID ì €ì¥ì„ ìœ„í•œ í¬ì¸í„°
// attr : (NULL) ì“°ë ˆë“œì— ë¶€ì—¬í•  íŠ¹ì„± ì •ë³´ (ê¸°ë³¸ì ì¸ ì“°ë ˆë“œ ìƒì„±)
// start_routine : ì“°ë ˆë“œê°€ ì²˜ë¦¬í•  í•¨ìˆ˜
// arg : í•¨ìˆ˜ í¬ì¸í„°ì— ì „ë‹¬í•  ì¸ìì˜ í¬ì¸í„°

pthread_create(&thread_id, NULL, thread_function, (void*)&thread_params);
```

ì˜ˆì‹œ)

```c
int main() {
    pthread_t thread_id;
    int thread_params = 5;
    
    if(pthread_create(&thread_id, NULL, thread_function, (void*)&thread_params) != 0) {
        puts("pthread_create() Error");
        return -1;
    }
    //...
    sleep(10); // í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œì‹œ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ëŒ€ê¸°
    return 0;
}

void* thread_function(void *arg) {
    int count = *((int*) arg);
    for(int i = 0; i < count ; i++) {
        sleep(1);
        printf("Thread is Running..\n");
    }
    return NULL;
}
```

### âœï¸ pthread\_join() ì“°ë ˆë“œì˜ ì¢…ë£Œ ëŒ€ê¸°

í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ ìƒì„±ëœ ì“°ë ˆë“œê°€ ì†Œë©¸ë˜ê¸° ë•Œë¬¸ì—,\
`pthread_join()` ì„ ì‚¬ìš©í•´ thread ì˜ ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦´ (blocking) ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```c
int pthread_join(pthread_t thread, void **status);
// thread : ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦´ thread ID
// status : ì“°ë ˆë“œ í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ê°’ì´ ì €ì¥ë  í¬ì¸í„° ë³€ìˆ˜ì˜ ì£¼ì†Œ

// ì„±ê³µì‹œ 0 ë°˜í™˜
```

ì˜ˆì‹œ)

```c
int main() {
    pthread_t thread_id;
    void *thread_return;
    // ...
    if(pthread_join(thread_id, &thread_return) != 0) {
        printf("pthread_join() ERROR!\n");
        return -1;
    }
    printf("Thread Return Message : %s\n", (char*)thread_return);
    free(thread_return);
}
```

## ğŸ“– Worker Thread Model

Worker Thread Model ì€ MultiThread í™˜ê²½ì—ì„œ,\
ì“°ë ˆë“œì—ê²Œ ì¼ì„ ì‹œí‚¤ê³ , ê²°ê³¼ë¥¼ ì·¨í•©í•˜ëŠ” ì“°ë ˆë“œ êµ¬ì„± ëª¨ë¸ì…ë‹ˆë‹¤.

ì´ë•Œ ì—¬ëŸ¬ ê°œì˜ ì“°ë ˆë“œê°€ ê³µìœ  ë©”ëª¨ë¦¬ (ì „ì—­ë³€ìˆ˜) ì— ì ‘ê·¼í•˜ê²Œ ë˜ëŠ”ë°\
ì´ ê³µìœ  ë©”ëª¨ë¦¬ ë³€ìˆ˜ì— ë™ê¸°í™” ë¬¸ì œê°€ ë°œìƒ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ì´ëŠ” ì“°ë ˆë“œì˜ ë¦¬ì†ŒìŠ¤ í• ë‹¹ì´ ìˆœì°¨ì ìœ¼ë¡œ ë°œìƒí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

### âœï¸ Critical Section

Critical Section (ì„ê³„ì˜ì—­) ì€ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ì ‘ê·¼ê°€ëŠ¥í•œ ê³µìœ ìì› ë˜ëŠ” ì½”ë“œë¥¼ ë§í•˜ê³ \
ì–´ëŠ í•œ ìˆœê°„ì—ëŠ” í•˜ë‚˜ì˜ ì“°ë ˆë“œë§Œ ì‚¬ìš© ê°€ëŠ¥í•œ ì˜ì—­ì„ ë§í•©ë‹ˆë‹¤.\
ë³´í†µ í™”ì¥ì‹¤ì— ë¹„ìœ í•©ë‹ˆë‹¤

ì„ê³„ ì˜ì—­ì— ë‘˜ ì´ìƒì˜ ì“°ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ë©´ ë™ê¸°í™” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

ë™ê¸°í™” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´

> 1. Mutex (Mutual Exclusion)
> 2. Semaphore

ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤



## ğŸ“– Mutex ê¸°ë°˜ì˜ ë™ê¸°í™”

### âœï¸ Mutex

Mutex ëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ê³µìœ  ìì›, ì„ê³„ì˜ì—­ì— ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ë™ê¸°í™” ê¸°ë²•ì…ë‹ˆë‹¤.

ë¨¼ì € `lock` ì„ íšë“í•˜ê³  ê³µìœ ìì›ì„ ì‚¬ìš© í•©ë‹ˆë‹¤\
ëŒ€ê¸°ì¤‘ì¸ thread ëŠ” `lock` ì„ íšë“ í•˜ê¸° ì „ê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤\
`lock` ì„ íšë“í•œ thread ëŠ” ì‚¬ìš©ì´ ëë‚˜ë©´ `lock` ì„ ë°˜ë‚©í•©ë‹ˆë‹¤

### âœï¸ pthread\_mutex\_t, lock, unlock

```c
#include<pthread.h>

pthread_mutex_t mutex;
int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *attr);
int pthread_mutex_destroy(pthread_mutex_t *mutex);
```

ë¥¼ ì‚¬ìš©í•˜ë©´ Mutex ë¥¼ ìƒì„±í•˜ê³  ì†Œë©¸ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤

```c
int pthread_mutex_lock(pthread_mutex_t *mutex);
int pthread_mutex_unlock(pthread_mutex_t *mutex);
```

ë¥¼ ì‚¬ìš©í•˜ì—¬ lock ì„ ê±¸ê³  í•´ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤



ì˜ˆ)

```c
pthread_mutex_t mutex;
int shared_resource;

void* thread_func1(void *arg);
void* thread_func2(void *arg);

int main() {
    pthread_t thread_id[NUM_THREAD];
    pthread_mutex_init(&mutex, NULL); // MUTEX ìƒì„±
    
    // ...
    
    pthread_mutex_destroy(&mutex);
    return 0;
}

void *thread_func1(void *arg){
    pthread_mutex_lock(&mutex);
    // ì„ê³„ì˜ì—­ : shared_resource ì— ëŒ€í•œ ì‘ì—…ì„ í•œë²ˆì— í•˜ë‚˜ì˜ ì“°ë ˆë“œë§Œ ì ‘ê·¼ ê°€ëŠ¥
    pthread_mutex_unlock(&mutex);    
}
```



## ğŸ“– Semaphore ê¸°ë°˜ì˜ ë™ê¸°í™”

### âœï¸ Semaphore

```c
#include <semaphore.h>

sem_t sem;
int sem_init(sem_t *sem, int pshared, unsigned int value);
// pshared == 0 : í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ ë‚´ì— ì¡´ì¬í•˜ëŠ” ì“°ë ˆë“œ ë“¤ì˜ ë™ê¸°í™”
// pshared != 0 : ë‘˜ ì´ìƒ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì ‘ê·¼ ê°€ëŠ¥í•œ ì„¸ë§ˆí¬ì–´ ìƒì„±
// value : ì„¸ë§ˆí¬ì–´ ì´ˆê¸°ê°’ ì§€ì •

int sem_destroy(sem_t *sem);
```

ë¥¼ ì‚¬ìš©í•´ ì„¸ë§ˆí¬ì–´ë¥¼ ìƒì„±í•˜ê³  ì†Œë©¸ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤



### âœï¸ Semaphore ì˜ íšë“ê³¼ ë°˜í™˜

```c
// ì„¸ë§ˆí¬ì–´ ê°’ ê°ì†Œ
int sem_wait(sem_t *sem);

// ì„¸ë§ˆí¬ì–´ ê°’ ì¦ê°€
int sem_post(sem_t *sem);
```

ì„¸ë§ˆí¬ì–´ ê°’ì´ 0 ì´ë©´ ì„ê³„ì˜ì—­ì— ì§„ì…í•˜ì§€ ëª»í•˜ê³ ,\
ì„¸ë§ˆí¬ì–´ ê°’ì´ 0 ì´ìƒì´ë©´ ì„ê³„ì˜ì—­ì— ì§„ì…í•  ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ

```c
sem_wait(&sem);
// ì„ê³„ ì˜ì—­
sem_post(&sem);
```

ì™€ ê°™ì´ ì„ê³„ ì˜ì—­ì„ êµ¬ì„±í•˜ë©´\
`sem_wait()` ì„ í˜¸ì¶œí•˜ê³ , ì„ê³„ ì˜ì—­ì— ì§„ì…í•œ ì“°ë ˆë“œê°€ `sem_post()` ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ê¹Œì§€\
ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ì„ê³„ ì˜ì—­ì— ì§„ì…í•˜ì§€ ëª»í•œë‹¤



### âœï¸ Semaphore ë¡œ í•¨ìˆ˜ í˜¸ì¶œ ìˆœì„œ ì œì–´

<figure><img src="../../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

ë‘ ê°œì˜ ì„¸ë§ˆí¬ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ í•¨ìˆ˜ í˜¸ì¶œì˜ ìˆœì„œë¥¼ ì œì–´ í•  ìˆ˜ ìˆë‹¤



ì˜ˆ)

```c
void *read(void *arg);
void *accu(void *arg);
static sem_t sem_one;
static sem_t sem_two;
static int num;

int main(int argc, char *argv[]){
    pthread_t t1, t2;
    sem_init(&sem_one, 0, 0); // sem_one ì´ˆê¸°ê°’ 0 
    sem_init(&sem_two, 0, 1); // sem_two ì´ˆê¸°ê°’ 1 - read ê°€ ë¨¼ì € ìˆ˜í–‰
    
    pthread_create(t1, NULL);
    pthread_create(t2, NULL);
    
    sem_destroy(&sem_one);
    sem_destroy(&sem_two);
    return 0;
}

void *read(void *arg){
    for(int i = 0; i < 5; i++){
        printf("Input : ");
        
        sem_wait(&sem_two); // sem_two ê°€ 1 ì´ë¯€ë¡œ read ë¥¼ í˜¸ì¶œí•˜ëŠ” t1 ì€ ì§„ì…ê°€ëŠ¥ í›„ ê°ì†Œ
        scanf("%d", &num);
        sem_post(&sem_one); // sem_one ì„ 0 ì—ì„œ 1ë¡œ ì¦ê°€
    }
}

void *accu(void *arg){
    int sum = 0;
    for(int i = 0; i < 5 ; i++) {
        sem_wait(&sem_one); // sem_one ì´ˆê¸°ê°’ì´ 0 ì´ë¯€ë¡œ t2 blocking
        sum += num;
        sem_post(&sem_two);
        printf("sum : %d\n", sum);
    }
    printf("result : %d\n", sum);
    return NULL;
}
```
